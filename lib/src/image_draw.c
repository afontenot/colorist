// ---------------------------------------------------------------------------
//                         Copyright Joe Drago 2018.
//         Distributed under the Boost Software License, Version 1.0.
//            (See accompanying file LICENSE_1_0.txt or copy at
//                  http://www.boost.org/LICENSE_1_0.txt)
// ---------------------------------------------------------------------------

#include "colorist/image.h"

#include "colorist/context.h"
#include "colorist/pixelmath.h"
#include "colorist/profile.h"
#include "colorist/transform.h"

#include <ctype.h>
#include <stdlib.h>
#include <string.h>

typedef struct Wavelength
{
    int wavelength;
    float x;
    float y;
    float z;
} Wavelength;

// table generated from http://www.cvrl.org/ciexyzpr.htm
static Wavelength cvrlTable[] = {
    { 390, 0.16638f, 0.01830f, 0.81532f }, { 391, 0.16635f, 0.01846f, 0.81519f }, { 392, 0.16629f, 0.01858f, 0.81513f },
    { 393, 0.16620f, 0.01867f, 0.81513f }, { 394, 0.16609f, 0.01872f, 0.81519f }, { 395, 0.16595f, 0.01874f, 0.81531f },
    { 396, 0.16579f, 0.01872f, 0.81548f }, { 397, 0.16561f, 0.01867f, 0.81572f }, { 398, 0.16542f, 0.01857f, 0.81601f },
    { 399, 0.16521f, 0.01844f, 0.81635f }, { 400, 0.16499f, 0.01827f, 0.81673f }, { 401, 0.16477f, 0.01807f, 0.81716f },
    { 402, 0.16455f, 0.01784f, 0.81761f }, { 403, 0.16433f, 0.01761f, 0.81806f }, { 404, 0.16412f, 0.01738f, 0.81849f },
    { 405, 0.16393f, 0.01718f, 0.81888f }, { 406, 0.16376f, 0.01702f, 0.81922f }, { 407, 0.16359f, 0.01688f, 0.81953f },
    { 408, 0.16341f, 0.01676f, 0.81983f }, { 409, 0.16320f, 0.01664f, 0.82015f }, { 410, 0.16296f, 0.01653f, 0.82052f },
    { 411, 0.16266f, 0.01640f, 0.82094f }, { 412, 0.16233f, 0.01627f, 0.82140f }, { 413, 0.16198f, 0.01614f, 0.82188f },
    { 414, 0.16162f, 0.01603f, 0.82235f }, { 415, 0.16126f, 0.01594f, 0.82280f }, { 416, 0.16093f, 0.01587f, 0.82320f },
    { 417, 0.16060f, 0.01583f, 0.82357f }, { 418, 0.16028f, 0.01582f, 0.82390f }, { 419, 0.15994f, 0.01584f, 0.82422f },
    { 420, 0.15958f, 0.01589f, 0.82453f }, { 421, 0.15920f, 0.01597f, 0.82483f }, { 422, 0.15879f, 0.01608f, 0.82513f },
    { 423, 0.15836f, 0.01622f, 0.82542f }, { 424, 0.15793f, 0.01637f, 0.82570f }, { 425, 0.15750f, 0.01653f, 0.82596f },
    { 426, 0.15709f, 0.01671f, 0.82620f }, { 427, 0.15669f, 0.01690f, 0.82641f }, { 428, 0.15628f, 0.01712f, 0.82660f },
    { 429, 0.15586f, 0.01738f, 0.82677f }, { 430, 0.15540f, 0.01767f, 0.82692f }, { 431, 0.15491f, 0.01802f, 0.82706f },
    { 432, 0.15439f, 0.01841f, 0.82720f }, { 433, 0.15384f, 0.01883f, 0.82733f }, { 434, 0.15329f, 0.01926f, 0.82745f },
    { 435, 0.15276f, 0.01968f, 0.82756f }, { 436, 0.15225f, 0.02008f, 0.82767f }, { 437, 0.15178f, 0.02047f, 0.82775f },
    { 438, 0.15131f, 0.02086f, 0.82782f }, { 439, 0.15085f, 0.02128f, 0.82787f }, { 440, 0.15036f, 0.02173f, 0.82790f },
    { 441, 0.14985f, 0.02225f, 0.82791f }, { 442, 0.14929f, 0.02282f, 0.82789f }, { 443, 0.14871f, 0.02343f, 0.82785f },
    { 444, 0.14811f, 0.02409f, 0.82780f }, { 445, 0.14749f, 0.02478f, 0.82773f }, { 446, 0.14687f, 0.02550f, 0.82763f },
    { 447, 0.14624f, 0.02625f, 0.82751f }, { 448, 0.14560f, 0.02706f, 0.82734f }, { 449, 0.14493f, 0.02795f, 0.82712f },
    { 450, 0.14423f, 0.02895f, 0.82682f }, { 451, 0.14349f, 0.03007f, 0.82643f }, { 452, 0.14271f, 0.03133f, 0.82597f },
    { 453, 0.14186f, 0.03271f, 0.82543f }, { 454, 0.14095f, 0.03422f, 0.82483f }, { 455, 0.13997f, 0.03584f, 0.82419f },
    { 456, 0.13890f, 0.03759f, 0.82351f }, { 457, 0.13775f, 0.03945f, 0.82279f }, { 458, 0.13653f, 0.04145f, 0.82202f },
    { 459, 0.13525f, 0.04359f, 0.82116f }, { 460, 0.13392f, 0.04588f, 0.82020f }, { 461, 0.13254f, 0.04834f, 0.81912f },
    { 462, 0.13112f, 0.05098f, 0.81790f }, { 463, 0.12964f, 0.05384f, 0.81652f }, { 464, 0.12807f, 0.05695f, 0.81498f },
    { 465, 0.12638f, 0.06036f, 0.81326f }, { 466, 0.12456f, 0.06410f, 0.81134f }, { 467, 0.12259f, 0.06822f, 0.80919f },
    { 468, 0.12046f, 0.07275f, 0.80678f }, { 469, 0.11818f, 0.07773f, 0.80409f }, { 470, 0.11574f, 0.08320f, 0.80106f },
    { 471, 0.11313f, 0.08922f, 0.79766f }, { 472, 0.11034f, 0.09582f, 0.79384f }, { 473, 0.10736f, 0.10307f, 0.78956f },
    { 474, 0.10418f, 0.11103f, 0.78479f }, { 475, 0.10078f, 0.11975f, 0.77947f }, { 476, 0.09715f, 0.12930f, 0.77354f },
    { 477, 0.09329f, 0.13971f, 0.76700f }, { 478, 0.08923f, 0.15097f, 0.75980f }, { 479, 0.08497f, 0.16308f, 0.75195f },
    { 480, 0.08055f, 0.17601f, 0.74344f }, { 481, 0.07599f, 0.18973f, 0.73427f }, { 482, 0.07130f, 0.20429f, 0.72441f },
    { 483, 0.06649f, 0.21974f, 0.71378f }, { 484, 0.06155f, 0.23615f, 0.70230f }, { 485, 0.05651f, 0.25359f, 0.68990f },
    { 486, 0.05138f, 0.27212f, 0.67650f }, { 487, 0.04622f, 0.29169f, 0.66209f }, { 488, 0.04108f, 0.31224f, 0.64668f },
    { 489, 0.03604f, 0.33365f, 0.63031f }, { 490, 0.03117f, 0.35580f, 0.61304f }, { 491, 0.02654f, 0.37853f, 0.59493f },
    { 492, 0.02222f, 0.40175f, 0.57604f }, { 493, 0.01827f, 0.42531f, 0.55642f }, { 494, 0.01477f, 0.44909f, 0.53614f },
    { 495, 0.01178f, 0.47294f, 0.51529f }, { 496, 0.00933f, 0.49673f, 0.49393f }, { 497, 0.00741f, 0.52049f, 0.47210f },
    { 498, 0.00596f, 0.54424f, 0.44980f }, { 499, 0.00490f, 0.56805f, 0.42705f }, { 500, 0.00418f, 0.59194f, 0.40387f },
    { 501, 0.00374f, 0.61593f, 0.38033f }, { 502, 0.00364f, 0.63984f, 0.35652f }, { 503, 0.00393f, 0.66346f, 0.33260f },
    { 504, 0.00471f, 0.68656f, 0.30872f }, { 505, 0.00605f, 0.70890f, 0.28505f }, { 506, 0.00802f, 0.73018f, 0.26180f },
    { 507, 0.01073f, 0.74993f, 0.23934f }, { 508, 0.01424f, 0.76771f, 0.21805f }, { 509, 0.01860f, 0.78319f, 0.19821f },
    { 510, 0.02382f, 0.79618f, 0.18001f }, { 511, 0.02983f, 0.80664f, 0.16352f }, { 512, 0.03645f, 0.81498f, 0.14857f },
    { 513, 0.04345f, 0.82161f, 0.13495f }, { 514, 0.05062f, 0.82692f, 0.12246f }, { 515, 0.05780f, 0.83125f, 0.11095f },
    { 516, 0.06485f, 0.83484f, 0.10031f }, { 517, 0.07183f, 0.83765f, 0.09052f }, { 518, 0.07882f, 0.83959f, 0.08158f },
    { 519, 0.08593f, 0.84060f, 0.07347f }, { 520, 0.09322f, 0.84063f, 0.06615f }, { 521, 0.10076f, 0.83968f, 0.05957f },
    { 522, 0.10849f, 0.83786f, 0.05365f }, { 523, 0.11636f, 0.83533f, 0.04831f }, { 524, 0.12431f, 0.83221f, 0.04349f },
    { 525, 0.13227f, 0.82861f, 0.03912f }, { 526, 0.14020f, 0.82463f, 0.03517f }, { 527, 0.14806f, 0.82034f, 0.03160f },
    { 528, 0.15582f, 0.81580f, 0.02838f }, { 529, 0.16344f, 0.81106f, 0.02550f }, { 530, 0.17090f, 0.80617f, 0.02292f },
    { 531, 0.17820f, 0.80119f, 0.02062f }, { 532, 0.18536f, 0.79609f, 0.01855f }, { 533, 0.19247f, 0.79084f, 0.01668f },
    { 534, 0.19958f, 0.78542f, 0.01500f }, { 535, 0.20674f, 0.77980f, 0.01346f }, { 536, 0.21399f, 0.77394f, 0.01207f },
    { 537, 0.22130f, 0.76790f, 0.01080f }, { 538, 0.22862f, 0.76172f, 0.00966f }, { 539, 0.23592f, 0.75544f, 0.00864f },
    { 540, 0.24316f, 0.74912f, 0.00773f }, { 541, 0.25030f, 0.74278f, 0.00692f }, { 542, 0.25736f, 0.73644f, 0.00620f },
    { 543, 0.26434f, 0.73010f, 0.00556f }, { 544, 0.27125f, 0.72376f, 0.00499f }, { 545, 0.27809f, 0.71742f, 0.00448f },
    { 546, 0.28489f, 0.71108f, 0.00403f }, { 547, 0.29164f, 0.70474f, 0.00362f }, { 548, 0.29834f, 0.69841f, 0.00326f },
    { 549, 0.30499f, 0.69208f, 0.00293f }, { 550, 0.31161f, 0.68576f, 0.00263f }, { 551, 0.31821f, 0.67944f, 0.00236f },
    { 552, 0.32481f, 0.67307f, 0.00211f }, { 553, 0.33148f, 0.66663f, 0.00189f }, { 554, 0.33825f, 0.66006f, 0.00170f },
    { 555, 0.34516f, 0.65332f, 0.00152f }, { 556, 0.35222f, 0.64642f, 0.00136f }, { 557, 0.35937f, 0.63941f, 0.00123f },
    { 558, 0.36653f, 0.63237f, 0.00110f }, { 559, 0.37363f, 0.62538f, 0.00099f }, { 560, 0.38061f, 0.61851f, 0.00089f },
    { 561, 0.38743f, 0.61177f, 0.00080f }, { 562, 0.39416f, 0.60512f, 0.00072f }, { 563, 0.40087f, 0.59849f, 0.00064f },
    { 564, 0.40763f, 0.59179f, 0.00058f }, { 565, 0.41450f, 0.58498f, 0.00052f }, { 566, 0.42152f, 0.57801f, 0.00047f },
    { 567, 0.42864f, 0.57094f, 0.00042f }, { 568, 0.43579f, 0.56383f, 0.00038f }, { 569, 0.44293f, 0.55672f, 0.00034f },
    { 570, 0.45001f, 0.54968f, 0.00031f }, { 571, 0.45698f, 0.54274f, 0.00028f }, { 572, 0.46388f, 0.53587f, 0.00025f },
    { 573, 0.47071f, 0.52906f, 0.00023f }, { 574, 0.47751f, 0.52229f, 0.00020f }, { 575, 0.48429f, 0.51553f, 0.00019f },
    { 576, 0.49105f, 0.50878f, 0.00017f }, { 577, 0.49782f, 0.50203f, 0.00015f }, { 578, 0.50458f, 0.49529f, 0.00014f },
    { 579, 0.51133f, 0.48854f, 0.00013f }, { 580, 0.51808f, 0.48181f, 0.00011f }, { 581, 0.52481f, 0.47509f, 0.00010f },
    { 582, 0.53145f, 0.46846f, 0.00009f }, { 583, 0.53795f, 0.46197f, 0.00008f }, { 584, 0.54425f, 0.45567f, 0.00008f },
    { 585, 0.55031f, 0.44962f, 0.00007f }, { 586, 0.55610f, 0.44384f, 0.00006f }, { 587, 0.56167f, 0.43828f, 0.00006f },
    { 588, 0.56707f, 0.43288f, 0.00005f }, { 589, 0.57236f, 0.42759f, 0.00005f }, { 590, 0.57757f, 0.42238f, 0.00004f },
    { 591, 0.58273f, 0.41723f, 0.00004f }, { 592, 0.58783f, 0.41214f, 0.00004f }, { 593, 0.59283f, 0.40714f, 0.00003f },
    { 594, 0.59772f, 0.40225f, 0.00003f }, { 595, 0.60249f, 0.39748f, 0.00003f }, { 596, 0.60712f, 0.39285f, 0.00003f },
    { 597, 0.61163f, 0.38834f, 0.00002f }, { 598, 0.61604f, 0.38394f, 0.00002f }, { 599, 0.62034f, 0.37963f, 0.00002f },
    { 600, 0.62457f, 0.37541f, 0.00002f }, { 601, 0.62871f, 0.37127f, 0.00002f }, { 602, 0.63276f, 0.36723f, 0.00002f },
    { 603, 0.63668f, 0.36330f, 0.00002f }, { 604, 0.64046f, 0.35952f, 0.00001f }, { 605, 0.64409f, 0.35589f, 0.00001f },
    { 606, 0.64756f, 0.35243f, 0.00001f }, { 607, 0.65088f, 0.34911f, 0.00001f }, { 608, 0.65405f, 0.34594f, 0.00001f },
    { 609, 0.65708f, 0.34291f, 0.00001f }, { 610, 0.66000f, 0.33999f, 0.00001f }, { 611, 0.66280f, 0.33719f, 0.00001f },
    { 612, 0.66548f, 0.33451f, 0.00001f }, { 613, 0.66807f, 0.33193f, 0.00001f }, { 614, 0.67055f, 0.32945f, 0.00001f },
    { 615, 0.67293f, 0.32706f, 0.00001f }, { 616, 0.67523f, 0.32477f, 0.00000f }, { 617, 0.67744f, 0.32256f, 0.00000f },
    { 618, 0.67958f, 0.32042f, 0.00000f }, { 619, 0.68166f, 0.31834f, 0.00000f }, { 620, 0.68369f, 0.31631f, 0.00000f },
    { 621, 0.68567f, 0.31433f, 0.00000f }, { 622, 0.68758f, 0.31242f, 0.00000f }, { 623, 0.68940f, 0.31060f, 0.00000f },
    { 624, 0.69111f, 0.30889f, 0.00000f }, { 625, 0.69269f, 0.30731f, 0.00000f }, { 626, 0.69415f, 0.30585f, 0.00000f },
    { 627, 0.69549f, 0.30451f, 0.00000f }, { 628, 0.69675f, 0.30325f, 0.00000f }, { 629, 0.69793f, 0.30207f, 0.00000f },
    { 630, 0.69907f, 0.30093f, 0.00000f }, { 631, 0.70017f, 0.29983f, 0.00000f }, { 632, 0.70124f, 0.29876f, 0.00000f },
    { 633, 0.70228f, 0.29772f, 0.00000f }, { 634, 0.70329f, 0.29671f, 0.00000f }, { 635, 0.70426f, 0.29574f, 0.00000f },
    { 636, 0.70520f, 0.29480f, 0.00000f }, { 637, 0.70612f, 0.29388f, 0.00000f }, { 638, 0.70703f, 0.29297f, 0.00000f },
    { 639, 0.70795f, 0.29205f, 0.00000f }, { 640, 0.70887f, 0.29113f, 0.00000f }, { 641, 0.70980f, 0.29020f, 0.00000f },
    { 642, 0.71071f, 0.28929f, 0.00000f }, { 643, 0.71157f, 0.28843f, 0.00000f }, { 644, 0.71236f, 0.28764f, 0.00000f },
    { 645, 0.71304f, 0.28696f, 0.00000f }, { 646, 0.71361f, 0.28639f, 0.00000f }, { 647, 0.71410f, 0.28590f, 0.00000f },
    { 648, 0.71452f, 0.28548f, 0.00000f }, { 649, 0.71490f, 0.28510f, 0.00000f }, { 650, 0.71528f, 0.28472f, 0.00000f },
    { 651, 0.71566f, 0.28434f, 0.00000f }, { 652, 0.71605f, 0.28395f, 0.00000f }, { 653, 0.71645f, 0.28355f, 0.00000f },
    { 654, 0.71685f, 0.28315f, 0.00000f }, { 655, 0.71725f, 0.28275f, 0.00000f }, { 656, 0.71764f, 0.28236f, 0.00000f },
    { 657, 0.71802f, 0.28198f, 0.00000f }, { 658, 0.71840f, 0.28160f, 0.00000f }, { 659, 0.71876f, 0.28124f, 0.00000f },
    { 660, 0.71912f, 0.28088f, 0.00000f }, { 661, 0.71946f, 0.28054f, 0.00000f }, { 662, 0.71978f, 0.28022f, 0.00000f },
    { 663, 0.72009f, 0.27991f, 0.00000f }, { 664, 0.72037f, 0.27963f, 0.00000f }, { 665, 0.72062f, 0.27938f, 0.00000f },
    { 666, 0.72084f, 0.27916f, 0.00000f }, { 667, 0.72104f, 0.27896f, 0.00000f }, { 668, 0.72122f, 0.27878f, 0.00000f },
    { 669, 0.72139f, 0.27861f, 0.00000f }, { 670, 0.72154f, 0.27846f, 0.00000f }, { 671, 0.72169f, 0.27831f, 0.00000f },
    { 672, 0.72182f, 0.27818f, 0.00000f }, { 673, 0.72195f, 0.27805f, 0.00000f }, { 674, 0.72208f, 0.27792f, 0.00000f },
    { 675, 0.72219f, 0.27781f, 0.00000f }, { 676, 0.72230f, 0.27770f, 0.00000f }, { 677, 0.72239f, 0.27761f, 0.00000f },
    { 678, 0.72248f, 0.27752f, 0.00000f }, { 679, 0.72257f, 0.27743f, 0.00000f }, { 680, 0.72265f, 0.27735f, 0.00000f },
    { 681, 0.72272f, 0.27728f, 0.00000f }, { 682, 0.72279f, 0.27721f, 0.00000f }, { 683, 0.72285f, 0.27715f, 0.00000f },
    { 684, 0.72291f, 0.27709f, 0.00000f }, { 685, 0.72296f, 0.27704f, 0.00000f }, { 686, 0.72300f, 0.27700f, 0.00000f },
    { 687, 0.72304f, 0.27696f, 0.00000f }, { 688, 0.72308f, 0.27692f, 0.00000f }, { 689, 0.72311f, 0.27689f, 0.00000f },
    { 690, 0.72314f, 0.27686f, 0.00000f }, { 691, 0.72317f, 0.27683f, 0.00000f }, { 692, 0.72320f, 0.27680f, 0.00000f },
    { 693, 0.72323f, 0.27677f, 0.00000f }, { 694, 0.72325f, 0.27675f, 0.00000f }, { 695, 0.72327f, 0.27673f, 0.00000f },
    { 696, 0.72328f, 0.27672f, 0.00000f }, { 697, 0.72329f, 0.27671f, 0.00000f }, { 698, 0.72329f, 0.27671f, 0.00000f },
    { 699, 0.72329f, 0.27671f, 0.00000f }, { 700, 0.72329f, 0.27671f, 0.00000f }, { 701, 0.72329f, 0.27671f, 0.00000f },
    { 702, 0.72329f, 0.27671f, 0.00000f }, { 703, 0.72329f, 0.27671f, 0.00000f }, { 704, 0.72329f, 0.27671f, 0.00000f },
    { 705, 0.72329f, 0.27671f, 0.00000f }, { 706, 0.72329f, 0.27671f, 0.00000f }, { 707, 0.72328f, 0.27672f, 0.00000f },
    { 708, 0.72327f, 0.27673f, 0.00000f }, { 709, 0.72325f, 0.27675f, 0.00000f }, { 710, 0.72323f, 0.27677f, 0.00000f },
    { 711, 0.72320f, 0.27680f, 0.00000f }, { 712, 0.72318f, 0.27682f, 0.00000f }, { 713, 0.72314f, 0.27686f, 0.00000f },
    { 714, 0.72311f, 0.27689f, 0.00000f }, { 715, 0.72308f, 0.27692f, 0.00000f }, { 716, 0.72305f, 0.27695f, 0.00000f },
    { 717, 0.72301f, 0.27699f, 0.00000f }, { 718, 0.72298f, 0.27702f, 0.00000f }, { 719, 0.72295f, 0.27705f, 0.00000f },
    { 720, 0.72292f, 0.27708f, 0.00000f }, { 721, 0.72288f, 0.27712f, 0.00000f }, { 722, 0.72284f, 0.27716f, 0.00000f },
    { 723, 0.72280f, 0.27720f, 0.00000f }, { 724, 0.72276f, 0.27724f, 0.00000f }, { 725, 0.72272f, 0.27728f, 0.00000f },
    { 726, 0.72268f, 0.27732f, 0.00000f }, { 727, 0.72264f, 0.27736f, 0.00000f }, { 728, 0.72259f, 0.27741f, 0.00000f },
    { 729, 0.72255f, 0.27745f, 0.00000f }, { 730, 0.72251f, 0.27749f, 0.00000f }, { 731, 0.72246f, 0.27754f, 0.00000f },
    { 732, 0.72242f, 0.27758f, 0.00000f }, { 733, 0.72237f, 0.27763f, 0.00000f }, { 734, 0.72233f, 0.27767f, 0.00000f },
    { 735, 0.72228f, 0.27772f, 0.00000f }, { 736, 0.72222f, 0.27778f, 0.00000f }, { 737, 0.72217f, 0.27783f, 0.00000f },
    { 738, 0.72211f, 0.27789f, 0.00000f }, { 739, 0.72204f, 0.27796f, 0.00000f }, { 740, 0.72198f, 0.27802f, 0.00000f },
    { 741, 0.72191f, 0.27809f, 0.00000f }, { 742, 0.72184f, 0.27816f, 0.00000f }, { 743, 0.72177f, 0.27823f, 0.00000f },
    { 744, 0.72169f, 0.27831f, 0.00000f }, { 745, 0.72162f, 0.27838f, 0.00000f }, { 746, 0.72155f, 0.27845f, 0.00000f },
    { 747, 0.72148f, 0.27852f, 0.00000f }, { 748, 0.72141f, 0.27859f, 0.00000f }, { 749, 0.72134f, 0.27866f, 0.00000f },
    { 750, 0.72127f, 0.27873f, 0.00000f }, { 751, 0.72120f, 0.27880f, 0.00000f }, { 752, 0.72112f, 0.27888f, 0.00000f },
    { 753, 0.72105f, 0.27895f, 0.00000f }, { 754, 0.72098f, 0.27902f, 0.00000f }, { 755, 0.72091f, 0.27909f, 0.00000f },
    { 756, 0.72083f, 0.27917f, 0.00000f }, { 757, 0.72075f, 0.27925f, 0.00000f }, { 758, 0.72068f, 0.27932f, 0.00000f },
    { 759, 0.72060f, 0.27940f, 0.00000f }, { 760, 0.72052f, 0.27948f, 0.00000f }, { 761, 0.72044f, 0.27956f, 0.00000f },
    { 762, 0.72037f, 0.27963f, 0.00000f }, { 763, 0.72030f, 0.27970f, 0.00000f }, { 764, 0.72022f, 0.27978f, 0.00000f },
    { 765, 0.72015f, 0.27985f, 0.00000f }, { 766, 0.72008f, 0.27992f, 0.00000f }, { 767, 0.72001f, 0.27999f, 0.00000f },
    { 768, 0.71994f, 0.28006f, 0.00000f }, { 769, 0.71987f, 0.28013f, 0.00000f }, { 770, 0.71980f, 0.28020f, 0.00000f },
    { 771, 0.71973f, 0.28027f, 0.00000f }, { 772, 0.71966f, 0.28034f, 0.00000f }, { 773, 0.71958f, 0.28042f, 0.00000f },
    { 774, 0.71951f, 0.28049f, 0.00000f }, { 775, 0.71943f, 0.28057f, 0.00000f }, { 776, 0.71936f, 0.28064f, 0.00000f },
    { 777, 0.71928f, 0.28072f, 0.00000f }, { 778, 0.71920f, 0.28080f, 0.00000f }, { 779, 0.71912f, 0.28088f, 0.00000f },
    { 780, 0.71904f, 0.28096f, 0.00000f }, { 781, 0.71895f, 0.28105f, 0.00000f }, { 782, 0.71887f, 0.28113f, 0.00000f },
    { 783, 0.71879f, 0.28121f, 0.00000f }, { 784, 0.71870f, 0.28130f, 0.00000f }, { 785, 0.71862f, 0.28138f, 0.00000f },
    { 786, 0.71853f, 0.28147f, 0.00000f }, { 787, 0.71845f, 0.28155f, 0.00000f }, { 788, 0.71836f, 0.28164f, 0.00000f },
    { 789, 0.71828f, 0.28172f, 0.00000f }, { 790, 0.71819f, 0.28181f, 0.00000f }, { 791, 0.71810f, 0.28190f, 0.00000f },
    { 792, 0.71802f, 0.28198f, 0.00000f }, { 793, 0.71793f, 0.28207f, 0.00000f }, { 794, 0.71783f, 0.28217f, 0.00000f },
    { 795, 0.71774f, 0.28226f, 0.00000f }, { 796, 0.71764f, 0.28236f, 0.00000f }, { 797, 0.71753f, 0.28247f, 0.00000f },
    { 798, 0.71743f, 0.28257f, 0.00000f }, { 799, 0.71732f, 0.28268f, 0.00000f }, { 800, 0.71721f, 0.28279f, 0.00000f },
    { 801, 0.71710f, 0.28290f, 0.00000f }, { 802, 0.71699f, 0.28301f, 0.00000f }, { 803, 0.71688f, 0.28312f, 0.00000f },
    { 804, 0.71677f, 0.28323f, 0.00000f }, { 805, 0.71666f, 0.28334f, 0.00000f }, { 806, 0.71655f, 0.28345f, 0.00000f },
    { 807, 0.71644f, 0.28356f, 0.00000f }, { 808, 0.71633f, 0.28367f, 0.00000f }, { 809, 0.71622f, 0.28378f, 0.00000f },
    { 810, 0.71611f, 0.28389f, 0.00000f }, { 811, 0.71599f, 0.28401f, 0.00000f }, { 812, 0.71588f, 0.28412f, 0.00000f },
    { 813, 0.71577f, 0.28423f, 0.00000f }, { 814, 0.71566f, 0.28434f, 0.00000f }, { 815, 0.71555f, 0.28445f, 0.00000f },
    { 816, 0.71544f, 0.28456f, 0.00000f }, { 817, 0.71533f, 0.28467f, 0.00000f }, { 818, 0.71522f, 0.28478f, 0.00000f },
    { 819, 0.71512f, 0.28488f, 0.00000f }, { 820, 0.71502f, 0.28498f, 0.00000f }, { 821, 0.71492f, 0.28508f, 0.00000f },
    { 822, 0.71482f, 0.28518f, 0.00000f }, { 823, 0.71473f, 0.28527f, 0.00000f }, { 824, 0.71464f, 0.28536f, 0.00000f },
    { 825, 0.71455f, 0.28545f, 0.00000f }, { 826, 0.71447f, 0.28553f, 0.00000f }, { 827, 0.71439f, 0.28561f, 0.00000f },
    { 828, 0.71431f, 0.28569f, 0.00000f }, { 829, 0.71424f, 0.28576f, 0.00000f },

    { 830, 0.71417f, 0.28583f, 0.00000f },
};
static const size_t cvrlTableSize = sizeof(cvrlTable) / sizeof(cvrlTable[0]);

typedef struct Scanline
{
    int minX;
    int maxX;
} Scanline;

static void updateScanlines(Scanline * scanlines, int dim, float fx0, float fy0, float fx1, float fy1)
{
    int x0 = (int)floorf(0.5f + (fx0 * (float)dim));
    int y0 = (int)floorf(0.5f + (fy0 * (float)dim));
    int x1 = (int)floorf(0.5f + (fx1 * (float)dim));
    int y1 = (int)floorf(0.5f + (fy1 * (float)dim));

    int xDist = x1 - x0;
    int xDir = 1;
    if (xDist < 0) {
        xDist *= -1;
        xDir = -1;
    }

    int yDist = y1 - y0;
    int yDir = 1;
    if (yDist < 0) {
        yDist *= -1;
        yDir = -1;
    }

    if ((yDist == 0) && (xDist == 0)) {
        // It's just a point
        if ((scanlines[y0].minX == -1) || (scanlines[y0].minX > x0)) {
            scanlines[y0].minX = x0;
        }
        if ((scanlines[y0].maxX == -1) || (scanlines[y0].maxX < x0)) {
            scanlines[y0].maxX = x0;
        }
    } else if (xDist > yDist) {
        // mostly horizontal line
        float slope = (float)yDist / (float)xDist;
        float errorTerm = 0.0f;
        int y = y0;
        for (int x = x0; x != (x1 + xDir); x += xDir) {
            if ((scanlines[y].minX == -1) || (scanlines[y].minX > x)) {
                scanlines[y].minX = x;
            }
            if ((scanlines[y].maxX == -1) || (scanlines[y].maxX < x)) {
                scanlines[y].maxX = x;
            }

            errorTerm += slope;
            if (errorTerm >= 0.5f) {
                errorTerm -= 1.0f;
                y += yDir;
            }
        }
    } else {
        // mostly vertical line
        float slope = (float)xDist / (float)yDist;
        float errorTerm = 0.0f;
        int x = x0;
        for (int y = y0; y != (y1 + yDir); y += yDir) {
            if ((scanlines[y].minX == -1) || (scanlines[y].minX > x)) {
                scanlines[y].minX = x;
            }
            if ((scanlines[y].maxX == -1) || (scanlines[y].maxX < x)) {
                scanlines[y].maxX = x;
            }

            errorTerm += slope;
            if (errorTerm >= 0.5f) {
                errorTerm -= 1.0f;
                x += xDir;
            }
        }
    }
}

void clImageDrawCIE(struct clContext * C, clImage * image, float borderColor[4], int borderThickness)
{
    clImagePrepareWritePixels(C, image, CL_PIXELFORMAT_F32);

    int luminance = CL_LUMINANCE_UNSPECIFIED;
    clProfileQuery(C, image->profile, NULL, NULL, &luminance);
    if (luminance == CL_LUMINANCE_UNSPECIFIED) {
        luminance = C->defaultLuminance;
    }

    clTransform * fromXYZ = clTransformCreate(C, NULL, CL_XF_XYZ, image->profile, CL_XF_RGBA, CL_TONEMAP_OFF);

    // Find the biggest square in the upper left to fill
    int dim = CL_MIN(image->width, image->height);

    Scanline * scanlines = clAllocate(sizeof(Scanline) * dim);
    for (int i = 0; i < dim; ++i) {
        scanlines[i].minX = -1;
        scanlines[i].maxX = -1;
    }

    float startX = cvrlTable[0].x;
    float startY = 1.0f - cvrlTable[0].y;
    float endX = cvrlTable[cvrlTableSize - 1].x;
    float endY = 1.0f - cvrlTable[cvrlTableSize - 1].y;
    updateScanlines(scanlines, dim, startX, startY, endX, endY);

    float lastX = startX;
    float lastY = startY;

    float rightmostX = startX;
    float rightmostY = startY;
    float botmostX = startX;
    float botmostY = startY;

    for (size_t i = 1; i < cvrlTableSize; i++) {
        float x = cvrlTable[i].x;
        float y = 1.0f - cvrlTable[i].y;

        if (rightmostX < x) {
            rightmostX = x;
            rightmostY = y;
        }
        if (botmostY < y) {
            botmostX = x;
            botmostY = y;
        }

        updateScanlines(scanlines, dim, lastX, lastY, x, y);

        lastX = x;
        lastY = y;
    }

    updateScanlines(scanlines, dim, rightmostX, rightmostY, botmostX, botmostY);

    for (int y = 0; y < dim; y++) {
        if (scanlines[y].minX == -1) {
            continue;
        }

        int len = scanlines[y].maxX - scanlines[y].minX;
        if (len > 0) {
            for (int x = scanlines[y].minX; x <= scanlines[y].maxX; x++) {
                float xyY[3];
                xyY[0] = (float)x / dim;
                xyY[1] = 1.0f - ((float)y / dim);
                xyY[2] = (float)luminance;

                float XYZ[3];
                clTransformXYYToXYZ(C, XYZ, xyY);

                float * pixel = &image->pixelsF32[CL_CHANNELS_PER_PIXEL * (x + (y * image->width))];
                clTransformRun(C, fromXYZ, XYZ, pixel, 1);
                float maxChannel = pixel[0];
                maxChannel = CL_MAX(maxChannel, pixel[1]);
                maxChannel = CL_MAX(maxChannel, pixel[2]);
                if (maxChannel > 0) {
                    pixel[0] /= maxChannel;
                    pixel[1] /= maxChannel;
                    pixel[2] /= maxChannel;
                }
            }
        }
    }

    if (borderThickness > 0) {
        lastX = startX;
        lastY = startY;

        int x0 = (int)floorf(0.5f + (rightmostX * (float)dim));
        int y0 = (int)floorf(0.5f + (rightmostY * (float)dim));
        int x1 = (int)floorf(0.5f + (botmostX * (float)dim));
        int y1 = (int)floorf(0.5f + (botmostY * (float)dim));
        clImageDrawLine(C, image, x0, y0, x1, y1, borderColor, borderThickness);

        for (size_t i = 0; i < cvrlTableSize; i++) {
            float x = cvrlTable[i].x;
            float y = 1.0f - cvrlTable[i].y;

            // float randomColor[4];
            // randomColor[0] = (float)rand() / (float)(RAND_MAX / 1.0f);
            // randomColor[1] = (float)rand() / (float)(RAND_MAX / 1.0f);
            // randomColor[2] = (float)rand() / (float)(RAND_MAX / 1.0f);
            // randomColor[3] = 1.0f;

            x0 = (int)floorf(0.5f + (lastX * (float)dim));
            y0 = (int)floorf(0.5f + (lastY * (float)dim));
            x1 = (int)floorf(0.5f + (x * (float)dim));
            y1 = (int)floorf(0.5f + (y * (float)dim));
            clImageDrawLine(C, image, x0, y0, x1, y1, borderColor, borderThickness);

            lastX = x;
            lastY = y;
        }
    }

    clFree(scanlines);
    clTransformDestroy(C, fromXYZ);
}

// Assumes clImagePrepareWritePixels(C, image, CL_PIXELFORMAT_F32) was called
static void clImageBlendPixel(struct clContext * C, clImage * image, int x, int y, float color[4], int thickness)
{
    (void)C;

    int offsetX = -1 * (thickness >> 1);
    int offsetY = -1 * (thickness >> 1);
    for (int j = 0; j < thickness; ++j) {
        for (int i = 0; i < thickness; ++i) {
            int pixelX = offsetX + x + i;
            int pixelY = offsetY + y + j;
            if ((pixelX < 0) || (pixelY < 0) || (pixelX > image->width - 1) || (pixelY > image->height - 1)) {
                continue;
            }

            float * dstPixel = &image->pixelsF32[CL_CHANNELS_PER_PIXEL * (pixelX + (pixelY * image->width))];

            float srcPixel[4];
            memcpy(srcPixel, dstPixel, sizeof(float) * 4);

            dstPixel[0] = (color[0] * color[3]) + (srcPixel[0] * srcPixel[3] * (1 - color[3]));
            dstPixel[1] = (color[1] * color[3]) + (srcPixel[1] * srcPixel[3] * (1 - color[3]));
            dstPixel[2] = (color[2] * color[3]) + (srcPixel[2] * srcPixel[3] * (1 - color[3]));
            dstPixel[3] = color[3] + (srcPixel[3] * (1 - color[3]));
        }
    }
}

void clImageDrawGamut(struct clContext * C,
                      clImage * image,
                      struct clProfilePrimaries * primaries,
                      float color[4],
                      int thickness,
                      float wpColor[4],
                      int wpThickness)
{
    int dim = CL_MIN(image->width, image->height);
    int x0, y0, x1, y1;

    if (thickness > 0) {
        x0 = (int)floorf(0.5f + (primaries->red[0] * (float)dim));
        y0 = (int)floorf(0.5f + ((1.0f - primaries->red[1]) * (float)dim));
        x1 = (int)floorf(0.5f + (primaries->green[0] * (float)dim));
        y1 = (int)floorf(0.5f + ((1.0f - primaries->green[1]) * (float)dim));
        clImageDrawLine(C, image, x0, y0, x1, y1, color, thickness);

        x0 = (int)floorf(0.5f + (primaries->red[0] * (float)dim));
        y0 = (int)floorf(0.5f + ((1.0f - primaries->red[1]) * (float)dim));
        x1 = (int)floorf(0.5f + (primaries->blue[0] * (float)dim));
        y1 = (int)floorf(0.5f + ((1.0f - primaries->blue[1]) * (float)dim));
        clImageDrawLine(C, image, x0, y0, x1, y1, color, thickness);

        x0 = (int)floorf(0.5f + (primaries->green[0] * (float)dim));
        y0 = (int)floorf(0.5f + ((1.0f - primaries->green[1]) * (float)dim));
        x1 = (int)floorf(0.5f + (primaries->blue[0] * (float)dim));
        y1 = (int)floorf(0.5f + ((1.0f - primaries->blue[1]) * (float)dim));
        clImageDrawLine(C, image, x0, y0, x1, y1, color, thickness);
    }

    if (wpThickness > 0) {
        x0 = (int)floorf(0.5f + (primaries->white[0] * (float)dim));
        y0 = (int)floorf(0.5f + ((1.0f - primaries->white[1]) * (float)dim));
        clImageBlendPixel(C, image, x0, y0, wpColor, wpThickness);
    }
}

void clImageDrawLine(struct clContext * C, clImage * image, int x0, int y0, int x1, int y1, float color[4], int thickness)
{
    clImagePrepareWritePixels(C, image, CL_PIXELFORMAT_F32);

    int xDist = x1 - x0;
    int xDir = 1;
    if (xDist < 0) {
        xDist *= -1;
        xDir = -1;
    }

    int yDist = y1 - y0;
    int yDir = 1;
    if (yDist < 0) {
        yDist *= -1;
        yDir = -1;
    }

    if ((yDist == 0) && (xDist == 0)) {
        // It's just a point
        clImageBlendPixel(C, image, x0, y0, color, thickness);
    } else if (xDist > yDist) {
        // mostly horizontal line
        float slope = (float)yDist / (float)xDist;
        float errorTerm = 0.0f;
        int y = y0;
        for (int x = x0; x != (x1 + xDir); x += xDir) {
            clImageBlendPixel(C, image, x, y, color, thickness);

            errorTerm += slope;
            if (errorTerm >= 0.5f) {
                errorTerm -= 1.0f;
                y += yDir;
            }
        }
    } else {
        // mostly vertical line
        float slope = (float)xDist / (float)yDist;
        float errorTerm = 0.0f;
        int x = x0;
        for (int y = y0; y != (y1 + yDir); y += yDir) {
            clImageBlendPixel(C, image, x, y, color, thickness);

            errorTerm += slope;
            if (errorTerm >= 0.5f) {
                errorTerm -= 1.0f;
                x += xDir;
            }
        }
    }
}
